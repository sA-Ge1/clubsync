Transaction State Machine and Allowed Transitions

Context:
transactions.status represents the lifecycle of an inventory borrowing transaction.

Status codes:
0 = PROCESSING
1 = DEPARTMENT APPROVAL PENDING
2 = DEPARTMENT REJECTED (terminal)
3 = DEPARTMENT APPROVED
4 = CLUB REJECTED (terminal)
5 = CLUB APPROVED
6 = COLLECTED
7 = OVERDUE
8 = RETURNED (terminal)

Department vs direct club flow:
- If the borrower is a student who belongs to the club that owns the inventory, or if the transaction is initiated by another club, the request can move directly from PROCESSING (0) to a club decision (4 or 5). Department approval is not required.
- If the borrower is a student who does NOT belong to the lending club, the request must go through department review before the club decision.

Allowed transitions:

From 0 (PROCESSING):
- To 1 (DEPARTMENT APPROVAL PENDING) when department approval is required.
- To 4 (CLUB REJECTED) when club directly rejects a same-club or club-to-club request.
- To 5 (CLUB APPROVED) when club directly approves a same-club or club-to-club request.

From 1 (DEPARTMENT APPROVAL PENDING):
- To 2 (DEPARTMENT REJECTED) if department rejects the request. This is terminal.
- To 3 (DEPARTMENT APPROVED) if department approves the request.

From 2 (DEPARTMENT REJECTED):
- No further transitions. This is a terminal cancelled state.

From 3 (DEPARTMENT APPROVED):
- To 4 (CLUB REJECTED) if club rejects after department approval. Terminal.
- To 5 (CLUB APPROVED) if club approves after department approval.

From 4 (CLUB REJECTED):
- No further transitions. This is a terminal cancelled state.

From 5 (CLUB APPROVED):
- To 6 (COLLECTED) once the borrower collects the item.
- Direct transitions to 7 or 8 are not allowed; collection must happen first.

From 6 (COLLECTED):
- To 7 (OVERDUE) if due_date has passed and item is not returned.
- To 8 (RETURNED) when the item is returned on or before due date.

From 7 (OVERDUE):
- To 8 (RETURNED) when an overdue item is finally returned.

From 8 (RETURNED):
- No further transitions. This is a terminal success state.

Global rules:
- No backward transitions are allowed (statuses cannot go to a lower code just to "undo" a decision).
- Once a transaction is in status 2 (DEPARTMENT REJECTED) or 4 (CLUB REJECTED), it is cancelled and cannot be approved or collected.
- Once status reaches 8 (RETURNED), the transaction is fully closed.



funds.type code-
expenditure-

0-Administrative
1-Event
2-Promotional
3-Equipment
4-Training
5-Miscellaneous


Income-

6-college
7-sponsors
8-Workshops
10-Members contribution
11-Services



db description
-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.auth (
  email character varying NOT NULL UNIQUE,
  role text NOT NULL DEFAULT 'notset'::text,
  student_id text,
  faculty_id text,
  club_id uuid,
  id uuid NOT NULL UNIQUE,
  CONSTRAINT auth_pkey PRIMARY KEY (id),
  CONSTRAINT auth_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.students(usn),
  CONSTRAINT auth_faculty_id_fkey FOREIGN KEY (faculty_id) REFERENCES public.faculty(faculty_id),
  CONSTRAINT auth_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id),
  CONSTRAINT auth_club_id_fkey FOREIGN KEY (club_id) REFERENCES public.clubs(club_id)
);
CREATE TABLE public.clubs (
  club_id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL UNIQUE,
  technical boolean,
  description text,
  faculty_id text,
  email text UNIQUE,
  CONSTRAINT clubs_pkey PRIMARY KEY (club_id),
  CONSTRAINT clubs_faculty_id_fkey FOREIGN KEY (faculty_id) REFERENCES public.faculty(faculty_id)
);
CREATE TABLE public.department_requests (
  request_id uuid NOT NULL DEFAULT gen_random_uuid(),
  dept_id uuid,
  created_at timestamp without time zone DEFAULT now(),
  usn text,
  transaction_id uuid,
  CONSTRAINT department_requests_pkey PRIMARY KEY (request_id),
  CONSTRAINT department_requests_dept_id_fkey FOREIGN KEY (dept_id) REFERENCES public.departments(dept_id),
  CONSTRAINT department_requests_usn_fkey FOREIGN KEY (usn) REFERENCES public.students(usn),
  CONSTRAINT department_requests_transaction_id_fkey FOREIGN KEY (transaction_id) REFERENCES public.transactions(transaction_id)
);
CREATE TABLE public.departments (
  dept_id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL UNIQUE,
  hod text,
  description text,
  CONSTRAINT departments_pkey PRIMARY KEY (dept_id),
  CONSTRAINT departments_hod_fkey FOREIGN KEY (hod) REFERENCES public.faculty(faculty_id)
);
CREATE TABLE public.faculty (
  faculty_id text NOT NULL,
  name text NOT NULL,
  email text UNIQUE,
  dept_id uuid,
  CONSTRAINT faculty_pkey PRIMARY KEY (faculty_id),
  CONSTRAINT faculty_dept_id_fkey FOREIGN KEY (dept_id) REFERENCES public.departments(dept_id)
);
create table public.funds (
  fund_id uuid not null default gen_random_uuid (),
  amount numeric(10, 2) null,
  description text null,
  club_id uuid null,
  is_credit boolean null,
  type smallint null default '0'::smallint,
  bill_date date null,
  name text null,
  is_trashed boolean null default false,
  submited_by text null,
  constraint funds_pkey primary key (fund_id),
  constraint funds_club_id_fkey foreign KEY (club_id) references clubs (club_id) on delete set null,
  constraint funds_submited_by_fkey foreign KEY (submited_by) references students (usn) on update RESTRICT on delete set null
) TABLESPACE pg_default;

CREATE TABLE public.inventory (
  inventory_id uuid NOT NULL DEFAULT gen_random_uuid(),
  club_id uuid,
  name text NOT NULL,
  description text,
  quantity integer DEFAULT 0 CHECK (quantity >= 0),
  cost numeric,
  image text,
  is_public boolean NOT NULL DEFAULT true,
  CONSTRAINT inventory_pkey PRIMARY KEY (inventory_id),
  CONSTRAINT inventory_club_id_fkey FOREIGN KEY (club_id) REFERENCES public.clubs(club_id)
);
CREATE TABLE public.memberships (
  member_id uuid NOT NULL DEFAULT gen_random_uuid(),
  usn text,
  club_id uuid,
  role text,
  CONSTRAINT memberships_pkey PRIMARY KEY (member_id),
  CONSTRAINT memberships_usn_fkey FOREIGN KEY (usn) REFERENCES public.students(usn),
  CONSTRAINT memberships_club_id_fkey FOREIGN KEY (club_id) REFERENCES public.clubs(club_id)
);
CREATE TABLE public.students (
  usn text NOT NULL,
  name text NOT NULL,
  email text NOT NULL UNIQUE,
  semester integer CHECK (semester >= 1 AND semester <= 8),
  dept_id uuid,
  CONSTRAINT students_pkey PRIMARY KEY (usn),
  CONSTRAINT students_dept_id_fkey FOREIGN KEY (dept_id) REFERENCES public.departments(dept_id)
);
CREATE TABLE public.transactions (
  transaction_id uuid NOT NULL DEFAULT gen_random_uuid(),
  student_id text,
  borrower_club_id uuid,
  inventory_id uuid,
  quantity integer CHECK (quantity > 0),
  date_of_issue timestamp without time zone DEFAULT now(),
  due_date timestamp without time zone,
  message text,
  updated_at timestamp without time zone DEFAULT now(),
  status smallint DEFAULT '0'::smallint,
  CONSTRAINT transactions_pkey PRIMARY KEY (transaction_id),
  CONSTRAINT transactions_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.students(usn),
  CONSTRAINT transactions_inventory_id_fkey FOREIGN KEY (inventory_id) REFERENCES public.inventory(inventory_id),
  CONSTRAINT transactions_borrower_club_id_fkey FOREIGN KEY (borrower_club_id) REFERENCES public.clubs(club_id)
);